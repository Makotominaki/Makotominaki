local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- GUI Container
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "NHUBGui"
screenGui.ResetOnSpawn = false

-- Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Parent = screenGui
toggleButton.Text = "NHUB DEAD RAILS"
toggleButton.Size = UDim2.new(0, 160, 0, 40)
toggleButton.Position = UDim2.new(1, -180, 0, 20)
toggleButton.BackgroundColor3 = Color3.fromRGB(40, 0, 0)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Font = Enum.Font.GothamBold
toggleButton.TextSize = 14
toggleButton.BorderSizePixel = 0

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainMenu"
mainFrame.Parent = screenGui
mainFrame.Size = UDim2.new(0, 300, 1, 0)
mainFrame.Position = UDim2.new(0, -300, 0, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 0, 0)
mainFrame.BorderSizePixel = 0

-- Scrollable
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Parent = mainFrame
scrollFrame.Size = UDim2.new(1, 0, 1, 0)
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 8
scrollFrame.BackgroundTransparency = 1
scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

local layout = Instance.new("UIListLayout", scrollFrame)
layout.Padding = UDim.new(0, 8)
layout.SortOrder = Enum.SortOrder.LayoutOrder

-- Helper Functions
local function createSectionHeader(text)
	local header = Instance.new("TextLabel")
	header.Size = UDim2.new(1, -20, 0, 30)
	header.Position = UDim2.new(0, 10, 0, 0)
	header.BackgroundTransparency = 1
	header.Text = "[ " .. text .. " ]"
	header.TextColor3 = Color3.fromRGB(255, 50, 50)
	header.Font = Enum.Font.GothamBold
	header.TextSize = 16
	header.TextXAlignment = Enum.TextXAlignment.Left
	header.Parent = scrollFrame
	return header
end

local function createButton(text, callback)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -20, 0, 40)
	btn.Position = UDim2.new(0, 10, 0, 0)
	btn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Text = text
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	btn.BorderSizePixel = 0
	btn.Parent = scrollFrame
	if callback then
		btn.MouseButton1Click:Connect(function()
			callback(btn)
		end)
	end
	return btn
end

-- === Sections ===
createSectionHeader("ปลดล็อคคลาสฟรี")
createButton("คลาสม้า", function()
	ReplicatedStorage.Shared.RemotePromise.Remotes.C_EquipClass:FireServer("Horse")
end)
createButton("คลาสไข่", function()
	ReplicatedStorage.Shared.RemotePromise.Remotes.C_EquipClass:FireServer("Eggslinger")
end)

-- === เปลี่ยนคลาส ===
createSectionHeader("เปลี่ยนคลาส")

local classList = {
    "Musician",
    "Doctor",
    "Miner",
    "Arsonist",
    "Packmaster",
    "Necromancer",
    "Werewolf",
    "HighRoller",
    "Conductor",
    "Cowboy",
    "Alamo",
    "Zombie",
    -- ถ้ามีต่อท้าย V... ตัดมาเพิ่มได้
}

for _, className in ipairs(classList) do
    createButton("คลาส: " .. className, function()
        local args = {
            [1] = className
        }
        ReplicatedStorage:WaitForChild("Shared"):WaitForChild("RemotePromise"):WaitForChild("Remotes"):WaitForChild("C_EquipClass"):FireServer(unpack(args))
    end)
end

createSectionHeader("ฟีเจอร์พิเศษ")
-- BOT LOCK
local npcLock = false
local toggleLoop
local lastTarget = nil
local camera = workspace.CurrentCamera

local function addPlayerHighlight()
    if player.Character then
        local highlight = player.Character:FindFirstChild("PlayerHighlightESP")
        if not highlight then
            highlight = Instance.new("Highlight")
            highlight.Name = "PlayerHighlightESP"
            highlight.FillColor = Color3.new(1, 1, 1)
            highlight.OutlineColor = Color3.new(1, 1, 1)
            highlight.FillTransparency = 0.5
            highlight.OutlineTransparency = 0
            highlight.Parent = player.Character
        end
    end
end

local function removePlayerHighlight()
    if player.Character and player.Character:FindFirstChild("PlayerHighlightESP") then
        player.Character.PlayerHighlightESP:Destroy()
    end
end

local function getClosestNPC()
    local closestNPC = nil
    local closestDistance = math.huge

    for _, object in ipairs(workspace:GetDescendants()) do
        if object:IsA("Model") then
            local humanoid = object:FindFirstChild("Humanoid") or object:FindFirstChildWhichIsA("Humanoid")
            local hrp = object:FindFirstChild("HumanoidRootPart") or object.PrimaryPart
            if humanoid and hrp and humanoid.Health > 0 and object.Name ~= "Horse" then
                local isPlayer = false
                for _, pl in ipairs(Players:GetPlayers()) do
                    if pl.Character == object then
                        isPlayer = true
                        break
                    end
                end
                if not isPlayer then
                    local distance = (hrp.Position - player.Character.HumanoidRootPart.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestNPC = object
                    end
                end
            end
        end
    end

    return closestNPC
end

createButton("ล็อกบอท: ปิด", function(btn)
    npcLock = not npcLock
    btn.Text = "ล็อกบอท: " .. (npcLock and "เปิด" or "ปิด")

    if npcLock then
        toggleLoop = RunService.RenderStepped:Connect(function()
            local npc = getClosestNPC()
            if npc and npc:FindFirstChild("Humanoid") then
                local npcHumanoid = npc:FindFirstChild("Humanoid")
                if npcHumanoid.Health > 0 then
                    camera.CameraSubject = npcHumanoid
                    lastTarget = npc
                    addPlayerHighlight()
                else
                    StarterGui:SetCore("SendNotification", {
                        Title = "กำจัดบอทแล้ว",
                        Text = npc.Name,
                        Duration = 0.4
                    })
                    lastTarget = nil
                    removePlayerHighlight()
                    if player.Character and player.Character:FindFirstChild("Humanoid") then
                        camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                    end
                end
            else
                if player.Character and player.Character:FindFirstChild("Humanoid") then
                    camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                end
                lastTarget = nil
                removePlayerHighlight()
            end
        end)
    else
        if toggleLoop then
            toggleLoop:Disconnect()
            toggleLoop = nil
        end
        removePlayerHighlight()
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
        end
    end
end)

-- Noclip
local noclip = false
createButton("Noclip: ปิด", function(btn)
	noclip = not noclip
	btn.Text = "Noclip: " .. (noclip and "เปิด" or "ปิด")
	for _, part in ipairs(player.Character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = not noclip
		end
	end
end)

RunService.Stepped:Connect(function()
	if noclip then
		for _, part in ipairs(player.Character:GetDescendants()) do
			if part:IsA("BasePart") and part.CanCollide then
				part.CanCollide = false
			end
		end
	end
end)

local allDropGui -- GUI ตัวหลัก

createButton("ทิ้งไอเทม", function(btn)
	if allDropGui then
		allDropGui:Destroy()
		allDropGui = nil
		btn.Text = "ทิ้งไอเทม"
	else
		-- สร้าง GUI
		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "AllDropGui"
		screenGui.ResetOnSpawn = false
		screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

		-- สร้างปุ่ม "ทิ้ง"
		local button = Instance.new("TextButton")
		button.Name = "AllDropButton"
		button.Size = UDim2.new(0, 50, 0, 50)
		button.Position = UDim2.new(0, 10, 0.5, -25)
		button.Text = "ทิ้ง"
		button.TextColor3 = Color3.new(1, 1, 1)
		button.TextSize = 18
		button.Font = Enum.Font.SourceSansBold
		button.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
		button.BorderSizePixel = 0
		button.AutoButtonColor = true
		button.Parent = screenGui

		-- มุมโค้ง
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(1, 0)
		corner.Parent = button

		-- ลากปุ่มได้
		local dragging = false
		local dragStart, startPos

		local function update(input)
			local delta = input.Position - dragStart
			button.Position = UDim2.new(
				0, startPos.X.Offset + delta.X,
				0, startPos.Y.Offset + delta.Y
			)
		end

		button.InputBegan:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
				dragging = true
				dragStart = input.Position
				startPos = button.Position
				input.Changed:Connect(function()
					if input.UserInputState == Enum.UserInputState.End then
						dragging = false
					end
				end)
			end
		end)

		game:GetService("UserInputService").InputChanged:Connect(function(input)
			if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
				update(input)
			end
		end)

		-- ปุ่มทิ้งของ 16 ครั้ง
		button.MouseButton1Click:Connect(function()
			local remote = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("DropItem")
			for i = 1, 16 do
				task.wait(0.1) -- กันสแปม
				remote:FireServer()
			end
		end)

		allDropGui = screenGui
		btn.Text = "ทิ้งไอเทม (ซ่อน)"
	end
end)

-- === Auto Egg Collector + Better Sack Handling (No Spam Unequip) ===
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

local autoCollectEggs = false
local range = 15
local holdingSack = false

local function getSackTool()
	for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
		if tool:IsA("Tool") and tool.Name == "Sack" then
			return tool
		end
	end
	for _, tool in ipairs(Character:GetChildren()) do
		if tool:IsA("Tool") and tool.Name == "Sack" then
			return tool
		end
	end
	return nil
end

local function isInRange(egg)
	local root = Character:FindFirstChild("HumanoidRootPart")
	if not root or not egg.PrimaryPart then return false end
	local distance = (egg.PrimaryPart.Position - root.Position).Magnitude
	return distance <= range
end

local function isValidEgg(v)
	return v:IsA("Model") and (v.Name == "SmallEgg" or v.Name == "MediumEgg") and v.PrimaryPart
end

local function findEggs()
	local eggs = {}
	for _, v in ipairs(getnilinstances()) do
		if isValidEgg(v) then table.insert(eggs, v) end
	end
	for _, v in ipairs(Workspace:GetDescendants()) do
		if isValidEgg(v) then table.insert(eggs, v) end
	end
	return eggs
end

local function loopCollectEggs()
	while autoCollectEggs do
		local eggs = findEggs()
		local inRange = {}

		for _, egg in ipairs(eggs) do
			if isInRange(egg) then
				table.insert(inRange, egg)
			end
		end

		local sack = getSackTool()

		if #inRange > 0 then
			if sack and not holdingSack then
				sack.Parent = Character
				holdingSack = true
			end
			for _, egg in ipairs(inRange) do
				ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("StoreItem"):FireServer(egg)
				task.wait(0.1)
			end
		else
			if sack and holdingSack then
				sack.Parent = LocalPlayer.Backpack
				holdingSack = false
			end
		end

		task.wait(0.5)
	end
end

-- ปุ่ม toggle
createButton("เก็บไข่ออโต้: ปิด", function(btn)
	autoCollectEggs = not autoCollectEggs
	btn.Text = "เก็บไข่ออโต้: " .. (autoCollectEggs and "เปิด" or "ปิด")
	if autoCollectEggs then
		task.spawn(loopCollectEggs)
	else
		-- ปิด auto: ย้าย Sack กลับไป Backpack ถ้ายังถืออยู่
		local sack = getSackTool()
		if sack and sack.Parent == Character then
			sack.Parent = LocalPlayer.Backpack
		end
		holdingSack = false
	end
end)

-- === ฟักไข่อัตโนมัติ ===
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local autoHatchEgg = false

local function isValidEgg(v)
	return v:IsA("Model") and (v.Name == "SmallEgg" or v.Name == "MediumEgg")
end

local function findAllEggs()
	local eggs = {}
	for _, v in next, getnilinstances() do
		if isValidEgg(v) then
			table.insert(eggs, v)
		end
	end
	for _, v in ipairs(Workspace:GetDescendants()) do
		if isValidEgg(v) then
			table.insert(eggs, v)
		end
	end
	return eggs
end

local function hatchEggLoop()
	while autoHatchEgg do
		local eggs = findAllEggs()
		for _, egg in ipairs(eggs) do
			local args = { [1] = egg }
			ReplicatedStorage:WaitForChild("Packages"):WaitForChild("RemotePromise")
				:WaitForChild("Remotes"):WaitForChild("C_ActivateObject")
				:FireServer(unpack(args))
			task.wait(0.25)
		end
		task.wait(1)
	end
end

-- ปุ่ม toggle ฟักไข่อัตโนมัติ (สไตล์เดียวกับ ESP)
createButton("ฟักไข่อัตโนมัติ: ปิด", function(btn)
	autoHatchEgg = not autoHatchEgg
	btn.Text = "ฟักไข่อัตโนมัติ: " .. (autoHatchEgg and "เปิด" or "ปิด")

	if not autoHatchEgg then
		-- ไม่ต้องทำอะไรเมื่อปิด
	else
		task.spawn(hatchEggLoop)
	end
end)

-- === กินน้ำมันงู ===
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local autoUseEnabled = false
local healthThresholdPercent = 30
local thresholdGui = nil -- เก็บ reference ของ GUI กลางจอ

local function getSnakeOil()
	return LocalPlayer.Backpack:FindFirstChild("Snake Oil") or (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Snake Oil"))
end

local function getUseRemote()
	for _, v in ipairs(game:GetDescendants()) do
		if v:IsA("RemoteEvent") and v.Name == "Use" then
			return v
		end
	end
end

local function equipSnakeOil()
	local character = LocalPlayer.Character
	local tool = LocalPlayer.Backpack:FindFirstChild("Snake Oil")
	if character and tool then
		tool.Parent = character
	end
end

local function useSnakeOil()
	local tool = getSnakeOil()
	local remote = getUseRemote()
	if tool and remote then
		remote:FireServer(tool)
	end
end

local function createThresholdGUI()
	if thresholdGui then thresholdGui:Destroy() end

	local screenGui = Instance.new("ScreenGui", PlayerGui)
	screenGui.Name = "HealthThresholdGui"
	screenGui.ResetOnSpawn = false
	thresholdGui = screenGui

	local frame = Instance.new("Frame", screenGui)
	frame.Size = UDim2.new(0, 300, 0, 150)
	frame.Position = UDim2.new(0.5, -150, 0.5, -75)
	frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	frame.BorderSizePixel = 0

	local label = Instance.new("TextLabel", frame)
	label.Size = UDim2.new(1, 0, 0.4, 0)
	label.Position = UDim2.new(0, 0, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = "เลือกว่าให้มันกินตอนเลือดกี่เปอร์เซ็นต์"
	label.TextColor3 = Color3.new(1, 1, 1)
	label.Font = Enum.Font.SourceSansBold
	label.TextSize = 18

	local textBox = Instance.new("TextBox", frame)
	textBox.Size = UDim2.new(0.8, 0, 0.3, 0)
	textBox.Position = UDim2.new(0.1, 0, 0.45, 0)
	textBox.PlaceholderText = "ใส่เลข 1 - 100"
	textBox.Text = ""
	textBox.Font = Enum.Font.SourceSans
	textBox.TextSize = 16
	textBox.TextColor3 = Color3.new(1, 1, 1)
	textBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

	local button = Instance.new("TextButton", frame)
	button.Size = UDim2.new(0.5, 0, 0.2, 0)
	button.Position = UDim2.new(0.25, 0, 0.8, 0)
	button.Text = "ตกลงเปอร์เซ็นต์เลือด"
	button.Font = Enum.Font.SourceSansBold
	button.TextSize = 16
	button.BackgroundColor3 = Color3.fromRGB(200, 50, 50) -- สีแดง
	button.TextColor3 = Color3.new(1, 1, 1)

	button.MouseButton1Click:Connect(function()
		local val = tonumber(textBox.Text)
		if val and val >= 1 and val <= 100 then
			healthThresholdPercent = val
			screenGui:Destroy()
			thresholdGui = nil
		else
			textBox.Text = "ใส่เลข 1 - 100"
		end
	end)
end

createButton("กินน้ำมันงูอัตโนมัติ: ปิด", function(btn)
	autoUseEnabled = not autoUseEnabled
	btn.Text = "กินน้ำมันงูอัตโนมัติ: " .. (autoUseEnabled and "เปิด" or "ปิด")

	if autoUseEnabled then
		createThresholdGUI()
	else
		if thresholdGui then
			thresholdGui:Destroy()
			thresholdGui = nil
		end
	end
end)

task.spawn(function()
	while true do
		if autoUseEnabled then
			local character = LocalPlayer.Character
			local humanoid = character and character:FindFirstChildOfClass("Humanoid")
			if humanoid then
				local hpPercent = (humanoid.Health / humanoid.MaxHealth) * 100
				if hpPercent <= healthThresholdPercent then
					equipSnakeOil()
					useSnakeOil()
				end
			end
		end
		task.wait(1)
	end
end)

-- ปลดล็อคกล้อง
createButton("ปลดล็อคกล้อง", function()
	if player.CameraMode == Enum.CameraMode.LockFirstPerson then
		player.CameraMode = Enum.CameraMode.Classic
	end
end)

-- MouseWheel Zoom
local zoomValue = 0
local zoomStep = 5
local minFOV = 40
local maxFOV = 120

userInput = game:GetService("UserInputService")
userInput.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseWheel then
		local newFov = Camera.FieldOfView - (input.Position.Z * zoomStep)
		Camera.FieldOfView = math.clamp(newFov, minFOV, maxFOV)
	end
end)

-- Toggle Menu
local menuOpen = false
toggleButton.MouseButton1Click:Connect(function()
	menuOpen = not menuOpen
	mainFrame:TweenPosition(
		menuOpen and UDim2.new(0, 0, 0, 0) or UDim2.new(0, -300, 0, 0),
		"Out", "Quad", 0.3, true
	)
end)

-- === HACK FLY ===
createButton("ลอยได้", function()
	-- รันสคริปต์ Fly
	loadstring(game:HttpGet("https://raw.githubusercontent.com/AmareScripts/DeadRails/refs/heads/main/FlyV2%25viaTurret.lua"))()
end)

-- === สร้างพื้นลอยฟ้า ===
local floatingPart = nil
local TweenService = game:GetService("TweenService")

createButton("สร้างพื้นลอยฟ้า", function(btn)
	if floatingPart then
		floatingPart:Destroy()
		floatingPart = nil
		btn.Text = "สร้างพื้นลอยฟ้า"
	else
		local char = player.Character
		if not char or not char:FindFirstChild("HumanoidRootPart") then return end
		local root = char.HumanoidRootPart

		floatingPart = Instance.new("Part")
		floatingPart.Size = Vector3.new(10, 1, 10)
		floatingPart.Anchored = true
		floatingPart.CanCollide = true
		floatingPart.Material = Enum.Material.ForceField
		floatingPart.Transparency = 0.25
		floatingPart.Color = Color3.fromRGB(100, 0, 150)
		floatingPart.Position = root.Position + Vector3.new(0, 6, 0)
		floatingPart.Name = "FloatingPlatform"
		floatingPart.Parent = workspace

		-- Tween ตัวละครไปบนพาร์ท
		local newCFrame = CFrame.new(floatingPart.Position + Vector3.new(0, 3, 0))
		local tweenInfo = TweenInfo.new(0.6, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
		local tween = TweenService:Create(root, tweenInfo, {CFrame = newCFrame})
		tween:Play()

		btn.Text = "ลบพื้นลอยฟ้า"
	end
end)

-- === X-ray Section ===
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local xrayEnabled = false
local xrayParts = {}
local xrayDistance = 20
local transparencyValue = 0.5

-- ตรวจว่ามี Highlight อยู่ในพาร์ทหรือเปล่า
local function hasHighlight(part)
	for _, child in ipairs(part:GetChildren()) do
		if child:IsA("Highlight") then
			return true
		end
	end
	return false
end

-- อัปเดต X-ray แบบ real-time
local function updateXray()
	if not xrayEnabled then return end

	local character = LocalPlayer.Character
	if not character then return end
	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local newParts = {}

	for _, part in ipairs(workspace:GetDescendants()) do
		if part:IsA("BasePart") and part.Transparency < 1 and not part:IsDescendantOf(character) then
			if not hasHighlight(part) then
				local distance = (part.Position - root.Position).Magnitude
				if distance <= xrayDistance then
					if not xrayParts[part] then
						part.LocalTransparencyModifier = transparencyValue
					end
					newParts[part] = true
				end
			end
		end
	end

	for part in pairs(xrayParts) do
		if not newParts[part] and part:IsDescendantOf(workspace) then
			part.LocalTransparencyModifier = 0
		end
	end

	xrayParts = newParts
end

-- ปุ่ม Toggle X-ray
createButton("X-ray: ปิด", function(btn)
	xrayEnabled = not xrayEnabled
	btn.Text = "X-ray: " .. (xrayEnabled and "เปิด" or "ปิด")

	if not xrayEnabled then
		for part in pairs(xrayParts) do
			if part:IsDescendantOf(workspace) then
				part.LocalTransparencyModifier = 0
			end
		end
		xrayParts = {}
	end
end)

-- อัปเดตทุกเฟรม
RunService.Heartbeat:Connect(function()
	if xrayEnabled then
		updateXray()
	end
end)

-- === Auto Melee Section (Only NPC) ===
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local enabled = false
local toolEquipped = false
local meleeTools = {}
local attackCooldown = 0.5
local lastAttackTime = 0
local npcDetectionRange = 15

local function isMeleeTool(tool)
	if tool:IsA("Tool") then
		local swingEvent = tool:FindFirstChild("SwingEvent")
		return swingEvent and swingEvent:IsA("RemoteEvent")
	end
	return false
end

local function scanMeleeTools()
	meleeTools = {}
	for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
		if isMeleeTool(tool) then
			table.insert(meleeTools, tool)
		end
	end
end

local function equipMeleeTools()
	local character = LocalPlayer.Character
	if not character then return end

	scanMeleeTools()

	for _, tool in ipairs(meleeTools) do
		if tool:IsDescendantOf(LocalPlayer.Backpack) then
			tool.Parent = character
		end
	end

	toolEquipped = true
end

local function unequipMeleeTools()
	local character = LocalPlayer.Character
	if not character then return end

	for _, tool in ipairs(character:GetChildren()) do
		if isMeleeTool(tool) then
			tool.Parent = LocalPlayer.Backpack
		end
	end

	toolEquipped = false
end

-- ตรวจหาเฉพาะ NPC เท่านั้น (ไม่นับผู้เล่น)
local function getNearbyNPC()
	local character = LocalPlayer.Character
	if not character then return nil end
	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return nil end

	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
			-- เช็คว่าไม่ใช่ตัวผู้เล่น และไม่ใช่ตัว LocalPlayer เอง
			if not Players:GetPlayerFromCharacter(obj) and obj ~= character then
				if obj.Humanoid.Health > 0 then
					local distance = (obj.HumanoidRootPart.Position - root.Position).Magnitude
					if distance <= npcDetectionRange then
						return obj
					end
				end
			end
		end
	end

	return nil
end

local function attackLoop()
	if tick() - lastAttackTime < attackCooldown then return end

	local character = LocalPlayer.Character
	if not character then return end

	for _, tool in ipairs(meleeTools) do
		local swing = tool:FindFirstChild("SwingEvent")
		if swing and swing:IsA("RemoteEvent") then
			local direction = Vector3.new(0, 0, -1)
			swing:FireServer(direction)
		end
	end

	lastAttackTime = tick()
end

-- ปุ่ม GUI เปิด/ปิด
createButton("ตีออโต้: ปิด", function(btn)
	enabled = not enabled
	btn.Text = "ตีออโต้: " .. (enabled and "เปิด" or "ปิด")

	if not enabled then
		unequipMeleeTools()
	end
end)

RunService.Heartbeat:Connect(function()
	if not enabled then return end
	local npc = getNearbyNPC()

	if npc then
		if not toolEquipped then
			equipMeleeTools()
		else
			local character = LocalPlayer.Character
			if character then
				local hasAll = true
				for _, tool in ipairs(meleeTools) do
					if not tool:IsDescendantOf(character) then
						hasAll = false
						break
					end
				end
				if not hasAll then
					equipMeleeTools()
				end
			end
		end
		attackLoop()
	else
		if toolEquipped then
			unequipMeleeTools()
		end
	end
end)

-- === ESP Section (Optimized) ===
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local espEnabled = false
local highlighted = {}

-- สร้าง Highlight
local function createHighlight(obj, color)
	if not obj or highlighted[obj] then return end

	local highlight = Instance.new("Highlight")
	highlight.Name = "AutoESP_Highlight"
	highlight.FillColor = color
	highlight.OutlineColor = Color3.new(1, 1, 1) -- ขอบขาว
	highlight.FillTransparency = 0.4
	highlight.OutlineTransparency = 0
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Adornee = obj
	highlight.Parent = obj:IsA("Model") and obj or obj:FindFirstAncestorWhichIsA("Model") or Workspace

	highlighted[obj] = highlight
end

-- เช็กว่าเป็น NPC
local function isNPC(model)
	return model:IsA("Model")
		and model:FindFirstChildOfClass("Humanoid")
		and not Players:GetPlayerFromCharacter(model)
end

-- เช็กว่าเป็น Player
local function isPlayer(model)
	return model:IsA("Model")
		and model:FindFirstChildOfClass("Humanoid")
		and Players:GetPlayerFromCharacter(model)
		and model ~= LocalPlayer.Character
end

-- เช็ก Egg
local function isEgg(part)
	return part:IsA("BasePart") and part.Name:lower() == "egg"
end

-- ตรวจสอบวัตถุ
local function checkObject(obj)
	if highlighted[obj] then return end
	if isNPC(obj) then
		createHighlight(obj, Color3.fromRGB(255, 0, 0)) -- NPC แดง
	elseif isPlayer(obj) then
		createHighlight(obj, Color3.fromRGB(0, 255, 0)) -- Player เขียว
	elseif isEgg(obj) then
		createHighlight(obj, Color3.fromRGB(255, 215, 0)) -- Egg ทอง
	end
end

-- ติดตาม Model ที่อาจจะกลายเป็น NPC/Player
local function trackModel(model)
	if highlighted[model] then return end
	if not model:IsA("Model") then return end

	model.ChildAdded:Connect(function(child)
		task.defer(function()
			checkObject(model)
			checkObject(child)
		end)
	end)
end

-- ติดตามของใหม่ที่ถูกเพิ่มใน Workspace
Workspace.DescendantAdded:Connect(function(obj)
	if espEnabled then
		task.defer(function()
			checkObject(obj)
			trackModel(obj)
		end)
	end
end)

-- ลูปสแกนทุก 0.5 วินาที แทนทุกเฟรม เพื่อลดแลค
task.spawn(function()
	while true do
		if espEnabled then
			for _, obj in ipairs(Workspace:GetDescendants()) do
				task.defer(function()
					checkObject(obj)
					trackModel(obj)
				end)
			end
		end
		task.wait(0.5)
	end
end)

-- ปุ่ม toggle ESP
createButton("ESP: ปิด", function(btn)
	espEnabled = not espEnabled
	btn.Text = "ESP: " .. (espEnabled and "เปิด" or "ปิด")

	if not espEnabled then
		for obj, hl in pairs(highlighted) do
			if hl and hl:IsA("Highlight") then
				hl:Destroy()
			end
		end
		highlighted = {}
	end
end)

-- === TELEPORT DEAD RAILS ===
createSectionHeader("วาร์ปไปตามสถานที่")

createButton("ไปหาเกวียน", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/tpfarm.github.io/refs/heads/main/tptofarm.lua"))()
end)

createButton("จบเกมส์อย่างสันติ", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/newpacifisct/refs/heads/main/newpacifisct.lua"))()
end)

createButton("ธนาคาร", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/Tptobank.github.io/refs/heads/main/Banktp.lua"))()
end)

createButton("ไปเมืองร้าง", function()
	loadstring(game:HttpGet('https://raw.githubusercontent.com/ringtaa/sterlingnotifcation.github.io/refs/heads/main/Sterling.lua'))()
end)

createButton("บอสเทสล่า", function()
	loadstring(game:HttpGet('https://raw.githubusercontent.com/ringtaa/tptotesla.github.io/refs/heads/main/Tptotesla.lua'))()
end)

createButton("ไปปราสาทแวมไพร์", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/castletpfast.github.io/refs/heads/main/FASTCASTLE.lua"))()
end)

createButton("ไปรังทหาร", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/Tpfort.github.io/refs/heads/main/Tpfort.lua"))()
end)

createButton("กลับรถไฟ", function()
	loadstring(game:HttpGet('https://raw.githubusercontent.com/ringtaa/train.github.io/refs/heads/main/train.lua'))()
end)
